<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘åˆ¶ä½œç®¡ç†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            background-color: #ffffff;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab {
            padding: 14px 20px;
            margin-right: 10px;
            cursor: pointer;
            background-color: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            color: #536171;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background-color: #f8fafc;
            color: #3498db;
        }
        .tab-content {
            display: none;
            padding: 25px;
            background-color: #ffffff;
            border-radius: 5px;
            margin: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .active-tab {
            background-color: #3498db;
            color: #ffffff;
            border: 1px solid #3498db;
        }
        .active-content {
            display: block;
        }

        /* Style for the new options */
        #newSceneOptions {
            margin-top: 20px;
            display: none;
        }
        #newSceneOptions button {
            display: block;
            padding: 12px 20px;
            margin: 8px 0;
            background-color: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            cursor: pointer;
            color: #536171;
            transition: all 0.3s ease;
            width: 200px;
        }
        #newSceneOptions button:hover {
            background-color: #3498db;
            color: #ffffff;
            border-color: #3498db;
        }
        
        /* æ–°å¢ä¸»æŒ‰é’®æ ·å¼ */
        button {
            padding: 12px 24px;
            background-color: #3498db;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        p {
            color: #536171;
            line-height: 1.6;
        }
        
        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .toolbar button {
            background-color: #ffffff;
            color: #536171;
            border: 1px solid #e1e8ed;
            padding: 10px 16px;
            font-size: 14px;
        }
        
        .toolbar button:hover {
            background-color: #f8fafc;
            color: #3498db;
            border-color: #3498db;
        }
        
        /* å½“æŒ‰é’®å¤„äºæ¿€æ´»çŠ¶æ€æ—¶çš„æ ·å¼ */
        .toolbar button.active {
            background-color: #3498db;
            color: #ffffff;
            border-color: #3498db;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            margin-top: 20px;
            overflow-x: auto;
            padding-right: 40px; /* ä¸ºé€‰æ‹©æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        .scene-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .scene-table th,
        .scene-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        .scene-table th {
            position: relative;
            padding: 12px 15px;
            background-color: #f8fafc;
            color: #2c3e50;
            font-weight: 600;
            white-space: nowrap;
        }

        .scene-table th[contenteditable="true"] {
            outline: none;
            min-width: 100px;
            transition: all 0.2s ease;
        }

        .scene-table th[contenteditable="true"]:hover {
            background-color: #f0f7ff;
        }

        .scene-table th[contenteditable="true"]:focus {
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #3498db;
        }

        .scene-table td {
            color: #536171;
        }

        .scene-table tbody tr:hover {
            background-color: #f8fafc;
        }

        /* ç¡®ä¿è¡¨æ ¼åœ¨å°å±å¹•ä¸Šå¯ä»¥æ¨ªå‘æ»šåŠ¨ */
        @media screen and (max-width: 1200px) {
            .table-container {
                max-width: 100%;
                overflow-x: auto;
            }
        }

        /* å¯ç¼–è¾‘å•å…ƒæ ¼æ ·å¼ */
        .scene-table td[contenteditable="true"] {
            position: relative;
            outline: none;
            min-width: 50px;
            transition: all 0.2s ease;
        }

        .scene-table td[contenteditable="true"]:hover {
            background-color: #f0f7ff;
        }

        .scene-table td[contenteditable="true"]:focus {
            background-color: #fff;
            box-shadow: inset 0 0 0 2px #3498db;
        }

        /* ç©ºå•å…ƒæ ¼æ ·å¼ */
        .scene-table td[contenteditable="true"]:empty::before {
            content: "";  /* ç§»é™¤"ç‚¹å‡»ç¼–è¾‘"æç¤ºæ–‡å­— */
        }

        /* æ·»åŠ æ‹–æ‹½ç›¸å…³æ ·å¼ */
        .scene-table tr[draggable="true"] {
            cursor: move;
        }

        .scene-table tr.dragging {
            opacity: 0.5;
            background-color: #f0f7ff;
        }

        .scene-table tr.drag-over {
            border-top: 2px solid #3498db;
        }

        /* ä¿®æ”¹ç¬¬ä¸€åˆ—æ ·å¼ */
        .scene-table td:first-child {
            cursor: move;
            user-select: none;
            position: relative;
            width: 30px; /* å›ºå®šå®½åº¦ */
            padding: 12px 0; /* ç§»é™¤å·¦å³padding */
            text-indent: -9999px; /* éšè—æ–‡å­—å†…å®¹ */
        }

        .scene-table td:first-child::before {
            content: "â‹®â‹®";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            opacity: 0.8;
            text-indent: 0;
            font-size: 18px;
        }

        .scene-table td:first-child:hover::before {
            color: #3498db;
        }

        /* ä¿®æ”¹æ’å…¥æŒ‰é’®çš„æ ·å¼ */
        .insert-column-btn {
            position: absolute;
            width: 12px;  /* è¿›ä¸€æ­¥å‡å°æŒ‰é’®å°ºå¯¸ */
            height: 12px; /* è¿›ä¸€æ­¥å‡å°æŒ‰é’®å°ºå¯¸ */
            border-radius: 50%;
            background-color: #ffffff;
            border: 1px solid #e1e8ed;
            color: #536171;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;  /* è¿›ä¸€æ­¥å‡å°åŠ å·å›¾æ ‡çš„å¤§å° */
            z-index: 2;
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        /* å·¦ä¾§æ’å…¥æŒ‰é’® */
        .insert-column-btn.left {
            left: -6px;  /* è°ƒæ•´ä½ç½®ä»¥é€‚åº”æ–°çš„å°ºå¯¸ */
            top: 50%;
            transform: translateY(-50%);
        }

        /* å³ä¾§æ’å…¥æŒ‰é’® */
        .insert-column-btn.right {
            right: -6px;  /* è°ƒæ•´ä½ç½®ä»¥é€‚åº”æ–°çš„å°ºå¯¸ */
            top: 50%;
            transform: translateY(-50%);
        }

        .scene-table th:hover .insert-column-btn {
            display: flex;
        }

        .insert-column-btn:hover {
            background-color: #3498db;
            color: #ffffff;
            border-color: #3498db;
        }

        /* æ·»åŠ åˆ—åˆ†éš”çº¿æ•ˆæœ */
        .scene-table th:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 1px;
            background-color: #e1e8ed;
        }

        /* ä¿®æ”¹å³ä¸Šè§’æŒ‰é’®å®¹å™¨æ ·å¼ï¼Œæ·»åŠ å†å²æ¨¡æ¿ç›¸å…³æ ·å¼ */
        .top-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        /* å†å²æ¨¡æ¿åˆ—è¡¨æ ·å¼ */
        .template-list {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #ffffff;
            min-width: 200px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px;
            margin-top: 5px;
        }

        .template-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e1e8ed;
            cursor: pointer;
        }

        .template-list-item:hover {
            background-color: #f8fafc;
        }

        .template-list-item .template-info {
            flex-grow: 1;
        }

        .template-list-item .template-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .template-list-item .template-date {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .template-list-item .template-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .template-list-item:hover .template-actions {
            opacity: 1;
        }

        .template-actions button {
            padding: 4px 8px;
            font-size: 12px;
            background: none;
            border: 1px solid #e1e8ed;
            color: #536171;
        }

        .template-actions button:hover {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        /* ä¿®æ”¹ä¸‹æ‹‰èœå•çš„æ˜¾ç¤ºé€»è¾‘ */
        .dropdown.active .dropdown-content,
        .dropdown.active .template-list {
            display: block;
        }

        /* å¯¼å‡ºä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #ffffff;
            min-width: 160px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 5px;
            z-index: 1;
        }

        .dropdown-content button {
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: #536171;
        }

        .dropdown-content button:hover {
            background-color: #f8fafc;
            color: #3498db;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* å›¾æ ‡æ ·å¼ */
        .button-icon {
            margin-right: 8px;
        }

        /* æ·»åŠ è¡Œæ’å…¥æŒ‰é’®æ ·å¼ */
        .scene-table tbody tr {
            position: relative;
        }

        .insert-row-btn {
            position: absolute;
            left: 15px; /* ç¬¬ä¸€åˆ—å®½åº¦è°ƒæ•´åçš„ä½ç½® */
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ffffff;
            border: 1px solid #e1e8ed;
            color: #536171;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            z-index: 1;
            transition: all 0.2s ease;
        }

        .scene-table tbody tr:hover .insert-row-btn {
            display: flex;
        }

        .insert-row-btn:hover {
            background-color: #3498db;
            color: #ffffff;
            border-color: #3498db;
        }

        /* è°ƒæ•´ç¬¬ä¸€åˆ—å®½åº¦ */
        .scene-table td:first-child {
            padding-left: 40px; /* ä¸ºæŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        /* æ·»åŠ é€‰æ‹©æŒ‰é’®æ ·å¼ */
        .select-row-btn {
            position: absolute;
            right: -30px; /* æ”¾åœ¨è¡¨æ ¼å³ä¾§ */
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background-color: #ffffff;
            border: 1px solid #e1e8ed;
            color: #536171;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .scene-table tbody tr:hover .select-row-btn {
            display: flex;
        }

        .select-row-btn:hover {
            background-color: #f0f7ff;
            border-color: #3498db;
            color: #3498db;
        }

        .select-row-btn.selected {
            background-color: #3498db;
            border-color: #3498db;
            color: #ffffff;
            display: flex;
        }

        /* æ·»åŠ åº•éƒ¨æ“ä½œæ æ ·å¼ */
        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 15px 25px;
            border-radius: 8px 8px 0 0;
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .bottom-actions.show {
            display: flex;
        }

        .bottom-actions .selection-info {
            color: #2c3e50;
            font-weight: 500;
            margin-right: 15px;
            padding-right: 15px;
            border-right: 1px solid #e1e8ed;
        }

        .bottom-actions button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #ffffff;
            color: #536171;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bottom-actions button:hover {
            background-color: #f0f7ff;
            color: #3498db;
            border-color: #3498db;
        }

        .bottom-actions button.delete {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .bottom-actions button.delete:hover {
            background-color: #e74c3c;
            color: #ffffff;
        }

        .bottom-actions button.cancel {
            background-color: #f8f9fa;
        }

        /* ä¿®æ”¹å­èœå•æ ·å¼ */
        .action-submenu {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            padding: 8px 0;
            display: none;
            min-width: 150px;
            margin-bottom: 10px; /* å¢åŠ é—´è· */
            z-index: 1002; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

        .action-submenu::after {
            content: '';
            position: absolute;
            bottom: -10px; /* è°ƒæ•´ç®­å¤´ä½ç½® */
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #ffffff;
        }

        /* ä¿®æ”¹å­èœå•çš„æ˜¾ç¤ºé€»è¾‘ */
        .has-submenu {
            position: relative;
            padding-top: 10px; /* ä¸ºå­èœå•ç•™å‡ºç©ºé—´ */
            padding-bottom: 10px;
        }

        /* æ·»åŠ ä¸€ä¸ªé€æ˜çš„åŒºåŸŸæ¥ä¿æŒå­èœå•æ˜¾ç¤º */
        .has-submenu::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 100%;
            height: 20px; /* å¢åŠ å¯ä»¥ç§»åŠ¨åˆ°å­èœå•çš„åŒºåŸŸ */
        }

        /* ä¿®æ”¹å­èœå•æ˜¾ç¤ºè§¦å‘æ–¹å¼ */
        .has-submenu.active .action-submenu {
            display: block;
        }

        /* ç§»åŠ¨ä½ç½®è¾“å…¥æ¡†å¼¹çª—æ ·å¼ */
        .move-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            min-width: 300px;
        }

        .move-dialog h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }

        .move-dialog input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
        }

        .move-dialog .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .move-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }

        .move-dialog button {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 4px;
        }

        .move-dialog button.cancel {
            background-color: #f8f9fa;
            color: #536171;
            border: 1px solid #e1e8ed;
        }

        .move-dialog button:not(.cancel) {
            background-color: #3498db;
            color: #ffffff;
            border: none;
        }

        /* æ·»åŠ åˆ—æ‹–åŠ¨æ ·å¼ */
        .scene-table th {
            cursor: move;
            user-select: none;
        }

        .scene-table th.dragging {
            opacity: 0.5;
            background-color: #f0f7ff;
        }

        .scene-table th.drag-over {
            border-left: 2px solid #3498db;
        }

        /* æ·»åŠ åˆ—å¤´ä¸‹æ‹‰ç®­å¤´æ ·å¼ */
        .column-menu-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #536171;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .scene-table th:hover .column-menu-btn {
            opacity: 1;
        }

        /* åˆ—èœå•æ ·å¼ */
        .column-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .column-menu.show {
            display: block;
        }

        .column-menu-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: #536171;
            transition: all 0.2s ease;
        }

        .column-menu-item:hover {
            background-color: #f0f7ff;
            color: #3498db;
        }

        .column-menu-item.has-submenu::after {
            content: 'â€º';
            margin-left: 8px;
        }

        /* åˆ—ç¼–è¾‘å­èœå• */
        .column-edit-menu {
            position: absolute;
            left: 100%;
            top: 0;
            background: #ffffff;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            padding: 12px;
        }

        .column-menu-item:hover .column-edit-menu {
            display: block;
        }

        /* åˆ—é€‰é¡¹æ ·å¼ */
        .column-options {
            margin-top: 8px;
            border-top: 1px solid #e1e8ed;
            padding-top: 8px;
        }

        .column-option-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
        }

        .add-option-btn {
            padding: 4px 8px;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
        }

        /* ç¼–è¾‘è¡¨å•æ ·å¼ */
        .edit-form-group {
            margin-bottom: 8px;
        }

        .edit-form-group label {
            display: block;
            margin-bottom: 4px;
            color: #2c3e50;
            font-size: 12px;
        }

        .edit-form-group input,
        .edit-form-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            font-size: 12px;
        }

        /* å•å…ƒæ ¼é€‰é¡¹ä¸‹æ‹‰èœå•æ ·å¼ */
        .cell-options-dropdown {
            position: absolute;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .cell-option-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cell-option-item:hover {
            background-color: #f0f7ff;
            color: #3498db;
        }

        /* åˆ—é€‰é¡¹è¾“å…¥æ¡†æ ·å¼ */
        .column-option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .column-option-item input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            font-size: 12px;
        }

        .column-option-item button {
            padding: 4px 8px;
            font-size: 12px;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            border-radius: 4px;
            background: none;
            cursor: pointer;
        }

        .column-option-item button:hover {
            background-color: #e74c3c;
            color: #ffffff;
        }

        /* æ·»åŠ é€‰é¡¹å¼¹çª—æ ·å¼ */
        .options-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            padding: 20px;
            min-width: 300px;
            z-index: 1100;
            display: none;
        }

        .options-dialog h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        .options-dialog .options-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .options-dialog .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .options-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1099;
            display: none;
        }

        /* æ·»åŠ é€‰é¡¹æŒ‰é’®æ ·å¼ */
        .options-dialog .add-option-btn {
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            margin: 10px 0;
            background: none;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .options-dialog .add-option-btn:hover {
            background-color: #f0f7ff;
        }

        /* é€‰æ‹©èœå•æ ·å¼ */
        .select-menu {
            position: relative;
            display: inline-block;
        }

        .select-menu button {
            background: #ffffff;
            border: 1px solid #e1e8ed;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            color: #536171;
        }

        .select-menu button:hover {
            background-color: #f8fafc;
            color: #3498db;
        }

        .select-menu .submenu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            min-width: 120px;
        }

        .select-menu .submenu.active {
            display: block;
        }

        .select-menu .submenu button {
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            padding: 8px 16px;
            border-radius: 0;
        }

        .select-menu .submenu button:hover {
            background-color: #f0f7ff;
        }

        /* ä¿®æ”¹è¡¨æ ¼åˆ—å®½æ ·å¼ */
        .scene-table th:nth-child(1), /* æ’åº */
        .scene-table td:nth-child(1) {
            width: 35px;  /* åŸ50pxå‡å°‘30% */
            min-width: 35px;
            max-width: 35px;
        }

        .scene-table th:nth-child(2), /* é•œå· */
        .scene-table td:nth-child(2) {
            width: 56px;  /* åŸ80pxå‡å°‘30% */
            min-width: 56px;
            max-width: 56px;
        }

        .scene-table th:nth-child(5), /* æ™¯åˆ« */
        .scene-table td:nth-child(5) {
            width: 70px;  /* åŸ100pxå‡å°‘30% */
            min-width: 70px;
            max-width: 70px;
        }

        .scene-table th:nth-child(7), /* æ—¶é•¿(ç§’) */
        .scene-table td:nth-child(7) {
            width: 56px;  /* åŸ80pxå‡å°‘30% */
            min-width: 56px;
            max-width: 56px;
        }

        /* æ‰©å¤§å…¶ä»–åˆ—çš„å®½åº¦ */
        .scene-table th:nth-child(3), /* åœºæ™¯é¢„æœŸ */
        .scene-table td:nth-child(3),
        .scene-table th:nth-child(4), /* æ‘„åƒæœºè§’åº¦ */
        .scene-table td:nth-child(4),
        .scene-table th:nth-child(6), /* æ‹æ‘„æ‰‹æ³• */
        .scene-table td:nth-child(6),
        .scene-table th:nth-child(8), /* å†…å®¹ */
        .scene-table td:nth-child(8),
        .scene-table th:nth-child(9), /* å°è¯ */
        .scene-table td:nth-child(9),
        .scene-table th:nth-child(10), /* å¤‡æ³¨ */
        .scene-table td:nth-child(10) {
            width: 160px;  /* åŸæ¥æ˜¯200pxï¼Œå‡å°‘20% */
            min-width: 160px;
        }

        /* è¡¨æ ¼å†…å®¹å±…ä¸­ */
        .scene-table th,
        .scene-table td {
            text-align: center !important;  /* ä½¿ç”¨!importantç¡®ä¿è¦†ç›–å…¶ä»–æ ·å¼ */
            vertical-align: middle;
        }

        /* ç©ºå•å…ƒæ ¼æ ·å¼å±…ä¸­ */
        .scene-table td[contenteditable="true"]:empty::before {
            text-align: center;
            width: 100%;
            display: block;
        }

        /* ç¡®ä¿è¡¨æ ¼å¯ä»¥æ¨ªå‘æ»šåŠ¨ */
        .table-container {
            overflow-x: auto;
            margin-right: 40px;  /* ä¸ºé€‰æ‹©æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        /* æ·»åŠ åˆ†é•œè®¾ç½®èœå•æ ·å¼ */
        .scene-settings-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            min-width: 150px;
        }

        .scene-settings-menu.active {
            display: block;
        }

        .scene-settings-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            border: none;
            background: none;
            color: #536171;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scene-settings-menu button:hover {
            background-color: #f0f7ff;
            color: #3498db;
        }

        /* æ·»åŠ æ–‡å­—å¤§å°å­èœå•æ ·å¼ */
        .submenu-item {
            position: relative;
        }

        .font-size-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            min-width: 100px;
        }

        .submenu-item:hover .font-size-submenu {
            display: block;
        }

        /* è¡¨æ ¼æ–‡å­—å¤§å°ç±» */
        .scene-table.font-size-large td,
        .scene-table.font-size-large th {
            font-size: 16px;
        }

        .scene-table.font-size-small td,
        .scene-table.font-size-small th {
            font-size: 12px;
        }

        /* ä¿®æ”¹è¡¨æ ¼æ–‡å­—å¤§å°ç±»ï¼Œæ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        .scene-table td,
        .scene-table th {
            transition: font-size 0.3s ease;  /* æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
        }

        .scene-table.font-size-xxl td, /* è¶…çº§å¤§ */
        .scene-table.font-size-xxl th {
            font-size: 22px;
        }

        .scene-table.font-size-xl-plus td, /* ç‰¹å¤§ */
        .scene-table.font-size-xl-plus th {
            font-size: 21px;
        }

        .scene-table.font-size-xl td, /* è¶…å¤§ */
        .scene-table.font-size-xl th {
            font-size: 20.5px;
        }

        .scene-table.font-size-large td, /* å¤§ */
        .scene-table.font-size-large th {
            font-size: 20.25px;
        }

        .scene-table.font-size-normal td, /* æ­£å¸¸ */
        .scene-table.font-size-normal th {
            font-size: 20px;
        }

        .scene-table.font-size-small td, /* å° */
        .scene-table.font-size-small th {
            font-size: 18px;
        }

        .scene-table.font-size-xs td, /* è¶…å° */
        .scene-table.font-size-xs th {
            font-size: 16px;
        }

        /* æ·»åŠ é•œå·è®¾ç½®å­èœå•æ ·å¼ */
        .scene-number-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: #ffffff;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
            min-width: 150px;
        }

        .submenu-item:hover .scene-number-submenu {
            display: block;
        }

        /* è‡ªå®šä¹‰é•œå·å¼€å…³æ ·å¼ */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .toggle-switch:hover {
            background-color: #f0f7ff;
            color: #3498db;
        }

        .toggle-switch input {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            margin-left: auto;
            transition: background-color 0.3s ease;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #3498db;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* æ·»åŠ PDFé¢„è§ˆè®¾ç½®å¼¹çª—æ ·å¼ */
        .pdf-preview-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            width: 800px;
        }

        .pdf-settings {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .pdf-setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pdf-setting-item label {
            color: #536171;
            white-space: nowrap;
        }

        .pdf-setting-item select,
        .pdf-setting-item input {
            padding: 6px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 4px;
            background: #fff;
            min-width: 100px;
        }

        .pdf-setting-item input[type="color"] {
            padding: 2px;
            width: 40px;
            height: 30px;
            cursor: pointer;
        }

        .logo-upload {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-preview {
            width: 40px;
            height: 40px;
            border: 1px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .pdf-preview-dialog .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .pdf-preview-dialog button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pdf-preview-dialog button.confirm {
            background: #3498db;
            color: white;
        }

        .pdf-preview-dialog button.cancel {
            background: #eee;
            color: #333;
        }

        /* æ·»åŠ PDFé¢„è§ˆç”»é¢æ ·å¼ */
        .pdf-preview-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            min-height: 500px;
        }

        .pdf-settings-panel {
            flex: 0 0 300px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pdf-preview-panel {
            flex: 1;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            overflow: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }

        .preview-table th,
        .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .preview-table th {
            background: #f8f9fa;
        }

        .preview-logo {
            max-width: 100px;
            margin-bottom: 20px;
        }

        /* ä¿®æ”¹å¼¹çª—æ ·å¼ä»¥é€‚åº”é¢„è§ˆ */
        .pdf-preview-dialog {
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            overflow: auto;
        }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab" onclick="showTab(0)">åˆ†é•œåˆ¶ä½œ</div>
        <div class="tab" onclick="showTab(1)">æ•…äº‹æ¿</div>
        <div class="tab" onclick="showTab(2)">æ‹æ‘„è®¡åˆ’</div>
        <div class="tab" onclick="showTab(3)">æ‹æ‘„é€šå‘Š</div>
    </div>

    <div class="tab-content" id="content1">
        <h2>åˆ†é•œåˆ¶ä½œå†…å®¹</h2>
        
        <!-- ä¿®æ”¹å³ä¸Šè§’æŒ‰é’®éƒ¨åˆ† -->
        <div class="top-actions">
            <button onclick="saveTable()" title="ä¿å­˜">
                <span class="button-icon">ğŸ’¾</span>ä¿å­˜
            </button>
            <div class="dropdown">
                <button onclick="toggleTemplateList(this)">
                    <span class="button-icon">ğŸ“‹</span>å†å²æ¨¡æ¿
                </button>
                <div class="template-list" id="templateList">
                    <!-- æ¨¡æ¿åˆ—è¡¨ä¼šé€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            <div class="dropdown">
                <button>
                    <span class="button-icon">ğŸ“¥</span>å¯¼å‡º
                </button>
                <div class="dropdown-content">
                    <button onclick="exportToExcel()">å¯¼å‡ºä¸º Excel</button>
                    <button onclick="exportToPDF()">å¯¼å‡ºä¸º PDF</button>
                </div>
            </div>
        </div>

        <p>è¿™é‡Œå¯ä»¥æ·»åŠ åˆ†é•œåˆ¶ä½œçš„è¯¦ç»†å†…å®¹ã€‚</p>

        <!-- ä¿®æ”¹å·¥å…·æ éƒ¨åˆ†çš„HTML -->
        <div class="toolbar">
            <button onclick="toggleNewSceneOptions()">æ–°å»º</button>
            <button onclick="toggleBatchMode()">æ‰¹é‡æ¨¡å¼</button>
            <div class="select-menu">
                <button onclick="toggleSubmenu(this)">é€‰æ‹© â–¼</button>
                <div class="submenu">
                    <button onclick="selectEmptyRows()">é€‰ä¸­ç©ºé•œå¤´</button>
                    <button onclick="selectAllRows()">å…¨é€‰</button>
                    <button onclick="cancelSelection()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            </div>
            <div class="select-menu">
                <button onclick="toggleSceneSettings(this)">åˆ†é•œè®¾ç½® â–¼</button>
                <div class="scene-settings-menu">
                    <div class="submenu-item">
                        <button onclick="toggleFontSizeMenu(this)">æ–‡å­—å¤§å° â€º</button>
                        <div class="font-size-submenu">
                            <button onclick="changeFontSize('large')">å¤§</button>
                            <button onclick="changeFontSize('small')">å°</button>
                        </div>
                    </div>
                    <button onclick="openImageRatioSettings()">å›¾ç‰‡æ¯”ä¾‹</button>
                    <button onclick="openImageFitSettings()">å›¾ç‰‡é€‚é…</button>
                    <div class="submenu-item">
                        <button onclick="toggleSceneNumberMenu(this)">é•œå·è®¾ç½® â€º</button>
                        <div class="scene-number-submenu">
                            <label class="toggle-switch">
                                è‡ªå®šä¹‰é•œå·
                                <input type="checkbox" onchange="toggleCustomSceneNumber(this)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="openColumnSettings()">åˆ—è®¾ç½®</button>
        </div>

        <!-- New Scene Options -->
        <div id="newSceneOptions">
            <button onclick="createScene(1)">åˆ›å»ºåˆ†é•œ</button>
            <button onclick="createScene(5)">åˆ›å»º5ä¸ªåˆ†é•œ</button>
            <button onclick="createScene(10)">åˆ›å»º10ä¸ªåˆ†é•œ</button>
            <button onclick="createScene(0)">åˆ›å»ºåœºæ™¯</button>
        </div>

        <!-- åˆ†é•œè¡¨æ ¼ -->
        <div class="table-container">
            <table class="scene-table">
                <thead>
                    <tr>
                        <th>æ’åº</th>
                        <th>é•œå·</th>
                        <th>åœºæ™¯é¢„æœŸ</th>
                        <th>æ‘„åƒæœºè§’åº¦</th>
                        <th>æ™¯åˆ«</th>
                        <th>æ‹æ‘„æ‰‹æ³•</th>
                        <th>æ—¶é•¿(ç§’)</th>
                        <th>å†…å®¹</th>
                        <th>å°è¯</th>
                        <th>å¤‡æ³¨</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td contenteditable="true">1</td>
                        <td contenteditable="true">1-1</td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- æ·»åŠ åº•éƒ¨æ“ä½œæ  -->
        <div class="bottom-actions">
            <span class="selection-info">å·²é€‰ä¸­ 0 ä¸ªé¡¹ç›®</span>
            <div class="has-submenu">
                <button type="button">æ’å…¥é•œå¤´ â–¼</button>
                <div class="action-submenu">
                    <button type="button" onclick="insertShotBefore()">å‘å‰æ’å…¥</button>
                    <button type="button" onclick="insertShotAfter()">å‘åæ’å…¥</button>
                </div>
            </div>
            <div class="has-submenu">
                <button type="button">ç§»åŠ¨é•œå¤´ â–¼</button>
                <div class="action-submenu">
                    <button type="button" onclick="moveShotToFront()">ç§»åˆ°æœ€å‰é¢</button>
                    <button type="button" onclick="moveShotToPosition()">ç§»åŠ¨æŒ‡å®šä½ç½®</button>
                    <button type="button" onclick="moveShotToEnd()">ç§»åˆ°æœ€åé¢</button>
                </div>
            </div>
            <button onclick="copyShot()">å¤åˆ¶é•œå¤´</button>
            <button onclick="deleteShot()" class="delete">åˆ é™¤é•œå¤´</button>
            <button onclick="cancelSelection()" class="cancel">å–æ¶ˆé€‰æ‹©</button>
        </div>

        <!-- æ·»åŠ ç§»åŠ¨ä½ç½®è¾“å…¥æ¡†å¼¹çª— -->
        <div class="move-dialog-overlay"></div>
        <div class="move-dialog">
            <h3>è¯·è¾“å…¥ç›®æ ‡é•œå·</h3>
            <input type="number" id="targetPosition" min="1" placeholder="è¯·è¾“å…¥é•œå·">
            <div class="dialog-buttons">
                <button onclick="closeDialog()" class="cancel">å–æ¶ˆ</button>
                <button onclick="confirmMove()">ç¡®å®š</button>
            </div>
        </div>

        <!-- æ·»åŠ PDFé¢„è§ˆè®¾ç½®å¼¹çª— -->
        <div class="dialog-overlay"></div>
        <div class="pdf-preview-dialog">
            <h3>PDF å¯¼å‡ºè®¾ç½®</h3>
            <div class="pdf-settings">
                <div class="pdf-setting-item">
                    <label>çº¸å¼ æ–¹å‘</label>
                    <select id="pdfOrientation" onchange="updatePreview()">
                        <option value="portrait">ç«–å‘</option>
                        <option value="landscape">æ¨ªå‘</option>
                    </select>
                </div>
                <div class="pdf-setting-item">
                    <label>æ–‡å­—å¤§å°</label>
                    <select id="pdfFontSize" onchange="updatePreview()">
                        <option value="small">å°</option>
                        <option value="medium" selected>ä¸­</option>
                        <option value="large">å¤§</option>
                    </select>
                </div>
                <div class="pdf-setting-item">
                    <label>æœ€å¤§åˆ—æ•°</label>
                    <select id="pdfMaxColumns" onchange="updatePreview()">
                        <!-- 4-20çš„é€‰é¡¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="pdf-setting-item">
                    <label>å¯¼èˆªé¢œè‰²</label>
                    <input type="color" id="pdfNavColor" value="#000000" onchange="updatePreview()">
                </div>
            </div>
            <div class="pdf-preview-container">
                <div id="previewContent"></div>
            </div>
            <div class="dialog-buttons">
                <button onclick="closePdfPreview()" class="cancel">å–æ¶ˆ</button>
                <button onclick="generatePDF()" class="confirm">å¯¼å‡ºPDF</button>
            </div>
        </div>
    </div>

    <div class="tab-content" id="content2">
        <h2>æ•…äº‹æ¿å†…å®¹</h2>
        <p>è¿™é‡Œå¯ä»¥æ·»åŠ æ•…äº‹æ¿çš„è¯¦ç»†å†…å®¹ã€‚</p>
    </div>

    <div class="tab-content" id="content3">
        <h2>æ‹æ‘„è®¡åˆ’å†…å®¹</h2>
        <p>è¿™é‡Œå¯ä»¥æ·»åŠ æ‹æ‘„è®¡åˆ’çš„è¯¦ç»†å†…å®¹ã€‚</p>
    </div>

    <div class="tab-content" id="content4">
        <h2>æ‹æ‘„é€šå‘Šå†…å®¹</h2>
        <p>è¿™é‡Œå¯ä»¥æ·»åŠ æ‹æ‘„é€šå‘Šçš„è¯¦ç»†å†…å®¹ã€‚</p>
    </div>

    <script>
        function showTab(index) {
            // Hide all contents
            let contents = document.querySelectorAll('.tab-content');
            for (let content of contents) {
                content.classList.remove('active-content');
            }

            // Remove active class from all tabs
            let tabs = document.querySelectorAll('.tab');
            for (let tab of tabs) {
                tab.classList.remove('active-tab');
            }

            // Show selected tab content
            document.getElementById('content' + (index + 1)).classList.add('active-content');
            tabs[index].classList.add('active-tab');
        }

        // Initialize with the first tab selected
        showTab(0);

        function toggleBatchMode() {
            const button = event.target;
            button.classList.toggle('active');
            
            // æ¸…é™¤æ‰€æœ‰é€‰æ‹©
            document.querySelectorAll('.select-row-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
                btn.parentElement.classList.remove('selected-row');
            });
        }

        // ä¿®æ”¹toggleSelectionå‡½æ•°
        function toggleSelection() {
            const selectMenu = document.querySelector('.select-menu button');
            if (selectMenu) {
                toggleSubmenu(selectMenu);
            }
        }

        function openSceneSettings() {
            // è¿™é‡Œæ·»åŠ æ‰“å¼€åˆ†é•œè®¾ç½®çš„å…·ä½“é€»è¾‘
            alert('æ‰“å¼€åˆ†é•œè®¾ç½®');
        }

        function openColumnSettings() {
            // è¿™é‡Œæ·»åŠ æ‰“å¼€åˆ—è®¾ç½®çš„å…·ä½“é€»è¾‘
            alert('æ‰“å¼€åˆ—è®¾ç½®');
        }

        // æ·»åŠ å›æ–°å»ºé€‰é¡¹çš„æ˜¾ç¤º/éšè—åŠŸèƒ½
        function toggleNewSceneOptions() {
            const options = document.getElementById('newSceneOptions');
            if (options.style.display === 'none' || options.style.display === '') {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
            }
        }

        // ä¿®æ”¹åˆ›å»ºåœºæ™¯å‡½æ•°
        function createScene(count) {
            if(count === 0) {
                // åˆ›å»ºåœºæ™¯çš„é€»è¾‘
                alert('åˆ›å»ºæ–°åœºæ™¯');
            } else {
                // åˆ›å»ºæŒ‡å®šæ•°é‡çš„åˆ†é•œ
                for(let i = 0; i < count; i++) {
                    addNewRow();
                }
            }
            // åˆ›å»ºå®Œæˆåéšè—é€‰é¡¹
            document.getElementById('newSceneOptions').style.display = 'none';
        }

        // ä¿®æ”¹æ·»åŠ æ–°è¡Œçš„å‡½æ•°
        function addNewRow(insertAfterIndex = -1) {
            const tbody = document.querySelector('.scene-table tbody');
            const rows = tbody.children;
            const newRow = document.createElement('tr');
            newRow.draggable = true;

            // åˆ›å»ºæ’å…¥æŒ‰é’®
            const insertBtn = document.createElement('button');
            insertBtn.className = 'insert-row-btn';
            insertBtn.innerHTML = '+';
            insertBtn.onclick = (e) => {
                e.stopPropagation();
                const currentIndex = Array.from(rows).indexOf(newRow);
                addNewRow(currentIndex);
            };

            // åˆ›å»ºé€‰æ‹©æŒ‰é’®
            const selectBtn = document.createElement('button');
            selectBtn.className = 'select-row-btn';
            selectBtn.innerHTML = 'âœ“';
            selectBtn.onclick = (e) => {
                e.stopPropagation();
                toggleRowSelection(selectBtn);
            };

            // åˆ›å»ºå•å…ƒæ ¼
            for(let i = 0; i < 10; i++) {
                const td = document.createElement('td');
                td.contentEditable = true;
                
                if(i === 0) {
                    // ç¬¬ä¸€åˆ—åªæ˜¾ç¤ºæ‹–æ‹½å›¾æ ‡
                    td.textContent = '';
                    td.contentEditable = false;
                    addLongPressHandler(td);
                }
                else if(i === 1) {
                    // é•œå·åˆ—ï¼Œåˆå§‹ä¸ºç©ºï¼Œç”±updateRowNumbersç»Ÿä¸€å¤„ç†
                    td.textContent = '';
                }
                
                newRow.appendChild(td);
            }

            // æ·»åŠ æ’å…¥æŒ‰é’®
            newRow.appendChild(insertBtn);

            // æ·»åŠ é€‰æ‹©æŒ‰é’®
            newRow.appendChild(selectBtn);

            // æ’å…¥åˆ°æŒ‡å®šä½ç½®
            if(insertAfterIndex >= 0 && insertAfterIndex < rows.length) {
                tbody.insertBefore(newRow, rows[insertAfterIndex + 1]);
            } else {
                tbody.appendChild(newRow);
            }

            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            addDragEvents(newRow);
            updateRowNumbers();
        }

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œä¸ºç°æœ‰è¡Œæ·»åŠ æŒ‰é’®
        function initializeInsertButtons() {
            const rows = document.querySelectorAll('.scene-table tbody tr');
            rows.forEach(row => {
                const insertBtn = document.createElement('button');
                insertBtn.className = 'insert-row-btn';
                insertBtn.innerHTML = '+';
                insertBtn.onclick = (e) => {
                    e.stopPropagation();
                    const currentIndex = Array.from(row.parentElement.children).indexOf(row);
                    addNewRow(currentIndex);
                };
                row.appendChild(insertBtn);

                // æ·»åŠ é€‰æ‹©æŒ‰é’®
                const selectBtn = document.createElement('button');
                selectBtn.className = 'select-row-btn';
                selectBtn.innerHTML = 'âœ“';
                selectBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleRowSelection(selectBtn);
                };
                row.appendChild(selectBtn);
            });
        }

        // ä¸ºç°æœ‰çš„è¡Œæ·»åŠ æ‹–æ‹½åŠŸèƒ½
        function initializeDragAndDrop() {
            const rows = document.querySelectorAll('.scene-table tbody tr');
            rows.forEach(row => {
                row.draggable = true;
                addDragEvents(row);
                const firstCell = row.querySelector('td:first-child');
                if (firstCell) {
                    firstCell.contentEditable = false;
                    addLongPressHandler(firstCell);
                }
            });
        }

        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
        function addDragEvents(row) {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragend', handleDragEnd);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
        }

        // é•¿æŒ‰è§¦å‘æ‹–æ‹½
        function addLongPressHandler(element) {
            let pressTimer;
            
            element.addEventListener('mousedown', function(e) {
                pressTimer = setTimeout(() => {
                    const row = element.parentElement;
                    row.draggable = true;
                }, 500);
            });

            element.addEventListener('mouseup', function(e) {
                clearTimeout(pressTimer);
            });

            element.addEventListener('mouseleave', function(e) {
                clearTimeout(pressTimer);
            });
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†å‡½æ•°
        function handleDragStart(e) {
            this.classList.add('dragging');
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            updateRowNumbers();
        }

        function handleDragOver(e) {
            e.preventDefault();
            const draggingRow = document.querySelector('.dragging');
            const rows = [...document.querySelectorAll('.scene-table tbody tr:not(.dragging)')];
            
            const row = rows.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = e.clientY - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;

            if (row) {
                row.classList.add('drag-over');
                setTimeout(() => row.classList.remove('drag-over'), 100);
                row.parentNode.insertBefore(draggingRow, row);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
        }

        // ä¿®æ”¹æ›´æ–°è¡Œå·å‡½æ•°
        function updateRowNumbers() {
            const rows = document.querySelectorAll('.scene-table tbody tr');
            rows.forEach((row, index) => {
                const sceneNumberCell = row.querySelector('td:nth-child(2)');
                if (sceneNumberCell) {
                    sceneNumberCell.textContent = index + 1;  // ç›´æ¥ä½¿ç”¨ä»1å¼€å§‹çš„æ•°å­—
                }
            });
        }

        // ä¿®æ”¹æ’å…¥åˆ—å‡½æ•°
        function insertColumn(index) {
            const table = document.querySelector('.scene-table');
            const rows = table.querySelectorAll('tr');
            
            // åœ¨æ¯ä¸€è¡Œæ’å…¥æ–°å•å…ƒæ ¼
            rows.forEach((row, rowIndex) => {
                const cell = document.createElement(rowIndex === 0 ? 'th' : 'td');
                cell.contentEditable = true;
                
                if(rowIndex === 0) {
                    // è¡¨å¤´å•å…ƒæ ¼
                    cell.textContent = 'æ–°åˆ—';  // è®¾ç½®é»˜è®¤æ–‡æœ¬
                    cell.setAttribute('draggable', 'true'); // æ·»åŠ æ‹–åŠ¨å±æ€§
                    
                    // æ·»åŠ æ‹–åŠ¨äº‹ä»¶ç›‘å¬å™¨
                    cell.addEventListener('dragstart', handleColumnDragStart);
                    cell.addEventListener('dragend', handleColumnDragEnd);
                    cell.addEventListener('dragover', handleColumnDragOver);
                    cell.addEventListener('drop', handleColumnDrop);
                }
                
                const targetCell = row.children[index];
                row.insertBefore(cell, targetCell);

                // å¦‚æœæ˜¯è¡¨å¤´è¡Œï¼Œåœ¨æ’å…¥åæ·»åŠ æŒ‰é’®
                if(rowIndex === 0) {
                    // æ·»åŠ å·¦ä¾§æ’å…¥æŒ‰é’®
                    const leftButton = document.createElement('button');
                    leftButton.className = 'insert-column-btn left';
                    leftButton.innerHTML = '+';
                    leftButton.title = 'åœ¨å·¦ä¾§æ’å…¥æ–°åˆ—';
                    leftButton.onclick = (e) => {
                        e.stopPropagation();
                        const currentIndex = Array.from(cell.parentElement.children).indexOf(cell);
                        insertColumn(currentIndex);
                    };
                    cell.appendChild(leftButton);

                    // æ·»åŠ å³ä¾§æ’å…¥æŒ‰é’®
                    const rightButton = document.createElement('button');
                    rightButton.className = 'insert-column-btn right';
                    rightButton.innerHTML = '+';
                    rightButton.title = 'åœ¨å³ä¾§æ’å…¥æ–°åˆ—';
                    rightButton.onclick = (e) => {
                        e.stopPropagation();
                        const currentIndex = Array.from(cell.parentElement.children).indexOf(cell);
                        insertColumn(currentIndex + 1);
                    };
                    cell.appendChild(rightButton);

                    // æ·»åŠ åˆ—èœå•æŒ‰é’®
                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'column-menu-btn';
                    menuBtn.innerHTML = 'â–¼';
                    menuBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.column-menu.show').forEach(menu => {
                            if (menu !== cell.querySelector('.column-menu')) {
                                menu.classList.remove('show');
                            }
                        });
                        cell.querySelector('.column-menu').classList.toggle('show');
                    };
                    cell.appendChild(menuBtn);

                    // åˆ›å»ºåˆ—èœå•
                    const menu = createColumnMenu(cell);
                    cell.appendChild(menu);
                }
            });
        }

        // ä¿®æ”¹åˆå§‹åŒ–åˆ—æŒ‰é’®å‡½æ•°
        function initializeColumnButtons() {
            const headers = document.querySelectorAll('.scene-table th');
            headers.forEach((header, index) => {
                if (index === 0) return; // è·³è¿‡ç¬¬ä¸€åˆ—

                header.contentEditable = true;
                
                // æ·»åŠ å·¦ä¾§æ’å…¥æŒ‰é’®
                const leftButton = document.createElement('button');
                leftButton.className = 'insert-column-btn left';
                leftButton.innerHTML = '+';
                leftButton.title = 'åœ¨å·¦ä¾§æ’å…¥æ–°åˆ—';
                leftButton.onclick = (e) => {
                    e.stopPropagation();
                    insertColumn(index);
                };
                header.appendChild(leftButton);

                // æ·»åŠ å³ä¾§æ’å…¥æŒ‰é’®
                const rightButton = document.createElement('button');
                rightButton.className = 'insert-column-btn right';
                rightButton.innerHTML = '+';
                rightButton.title = 'åœ¨å³ä¾§æ’å…¥æ–°åˆ—';
                rightButton.onclick = (e) => {
                    e.stopPropagation();
                    insertColumn(index + 1);
                };
                header.appendChild(rightButton);
                
                // æ·»åŠ åˆ—èœå•æŒ‰é’®
                const menuBtn = document.createElement('button');
                menuBtn.className = 'column-menu-btn';
                menuBtn.innerHTML = 'â–¼';
                menuBtn.onclick = (e) => {
                    e.stopPropagation();
                    // å…³é—­å…¶ä»–æ‰“å¼€çš„èœå•
                    document.querySelectorAll('.column-menu.show').forEach(menu => {
                        if (menu !== header.querySelector('.column-menu')) {
                            menu.classList.remove('show');
                        }
                    });
                    // åˆ‡æ¢å½“å‰èœå•
                    header.querySelector('.column-menu').classList.toggle('show');
                };
                header.appendChild(menuBtn);

                // åˆ›å»ºåˆ—èœå•
                const menu = createColumnMenu(header);
                header.appendChild(menu);
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.column-menu') && !e.target.closest('.column-menu-btn')) {
                    document.querySelectorAll('.column-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
        }

        // ä¿®æ”¹æ›´æ–°åˆ—ç±»å‹å‡½æ•°
        function updateColumnType(select, columnIndex) {
            const header = select.closest('th');
            const optionsGroup = header.querySelector('.column-options');
            // ç§»é™¤ç±»å‹ç›¸å…³çš„æ˜¾ç¤º/éšè—é€»è¾‘ï¼Œé€‰é¡¹å§‹ç»ˆæ˜¾ç¤º
        }

        // ä¿®æ”¹éšè—åˆ—å‡½æ•°
        function hideColumn(header) {
            const index = Array.from(header.parentElement.children).indexOf(header);
            const table = header.closest('table');
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                row.children[index].style.display = 'none';
            });
            // å…³é—­èœå•
            header.querySelector('.column-menu').classList.remove('show');
        }

        // ä¿®æ”¹åˆ é™¤åˆ—å‡½æ•°
        function deleteColumn(header) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤åˆ—å—ï¼Ÿ')) return;
            const index = Array.from(header.parentElement.children).indexOf(header);
            const table = header.closest('table');
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                row.children[index].remove();
            });
        }

        // ä¿®æ”¹åˆ›å»ºåˆ—èœå•å‡½æ•°ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
        function createColumnMenu(header) {
            const menu = document.createElement('div');
            menu.className = 'column-menu';
            
            // ç¼–è¾‘åˆ—é€‰é¡¹
            const editItem = document.createElement('div');
            editItem.className = 'column-menu-item has-submenu';
            editItem.textContent = 'ç¼–è¾‘åˆ—';
            
            // åˆ›å»ºç¼–è¾‘å­èœå•
            const editMenu = createEditSubmenu(header);
            editItem.appendChild(editMenu);
            
            // éšè—åˆ—é€‰é¡¹
            const hideItem = document.createElement('div');
            hideItem.className = 'column-menu-item';
            hideItem.textContent = 'éšè—åˆ—';
            hideItem.onclick = () => hideColumn(header);
            
            // åˆ é™¤åˆ—é€‰é¡¹
            const deleteItem = document.createElement('div');
            deleteItem.className = 'column-menu-item';
            deleteItem.textContent = 'åˆ é™¤åˆ—';
            deleteItem.onclick = () => deleteColumn(header);
            
            menu.appendChild(editItem);
            menu.appendChild(hideItem);
            menu.appendChild(deleteItem);
            
            return menu;
        }

        // ä¿®æ”¹åˆ›å»ºç¼–è¾‘å­èœå•å‡½æ•°
        function createEditSubmenu(header) {
            const editMenu = document.createElement('div');
            editMenu.className = 'column-edit-menu';
            
            // è·å–å½“å‰åˆ—çš„ç´¢å¼•
            const columnIndex = Array.from(header.parentElement.children).indexOf(header);
            
            // åˆ—æ ‡é¢˜è¾“å…¥
            const titleGroup = document.createElement('div');
            titleGroup.className = 'edit-form-group';
            const headerText = header.textContent.replace(/[+â–¼]/, '').trim();
            titleGroup.innerHTML = `
                <label>åˆ—æ ‡é¢˜</label>
                <input type="text" value="${headerText}" onchange="updateColumnTitle(this)">
            `;
            
            // åˆ—ç±»å‹é€‰æ‹©
            const typeGroup = document.createElement('div');
            typeGroup.className = 'edit-form-group';
            typeGroup.innerHTML = `
                <label>åˆ—ç±»å‹</label>
                <select onchange="updateColumnType(this, ${columnIndex})">
                    <option value="text">æ–‡æœ¬</option>
                    <option value="number">æ•°å­—</option>
                </select>
            `;

            // é€‰é¡¹æŒ‰é’®
            const optionsGroup = document.createElement('div');
            optionsGroup.className = 'edit-form-group';
            optionsGroup.innerHTML = `
                <button onclick="showOptionsDialog(${columnIndex})" style="width: 100%;">
                    ç®¡ç†é€‰é¡¹
                </button>
            `;
            
            editMenu.appendChild(titleGroup);
            editMenu.appendChild(typeGroup);
            editMenu.appendChild(optionsGroup);
            
            return editMenu;
        }

        // ä¿®æ”¹é€‰é¡¹å¼¹çª—ç›¸å…³å‡½æ•°
        function showOptionsDialog(columnIndex) {
            // åˆ›å»ºå¼¹çª—å’Œé®ç½©
            const overlay = document.createElement('div');
            overlay.className = 'options-dialog-overlay';
            
            const dialog = document.createElement('div');
            dialog.className = 'options-dialog';
            
            // è·å–ç°æœ‰é€‰é¡¹
            const options = JSON.parse(localStorage.getItem(`column_${columnIndex}_options`) || '[]');
            
            dialog.innerHTML = `
                <h3>ç®¡ç†é€‰é¡¹</h3>
                <div class="options-list">
                    ${options.map(option => `
                        <div class="column-option-item">
                            <input type="text" value="${option}">
                            <button onclick="removeOptionInDialog(this)">åˆ é™¤</button>
                        </div>
                    `).join('')}
                </div>
                <button type="button" onclick="addOptionInDialog()" class="add-option-btn">
                    <span style="margin-right: 8px;">+</span>æ·»åŠ é€‰é¡¹
                </button>
                <div class="dialog-buttons">
                    <button onclick="saveOptions(${columnIndex})" class="save-btn">ä¿å­˜</button>
                    <button onclick="closeOptionsDialog()">å–æ¶ˆ</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(dialog);
            
            overlay.style.display = 'block';
            dialog.style.display = 'block';
        }

        // æ·»åŠ é€‰é¡¹å‡½æ•°
        function addOptionInDialog() {
            const optionsList = document.querySelector('.options-dialog .options-list');
            const optionItem = document.createElement('div');
            optionItem.className = 'column-option-item';
            optionItem.innerHTML = `
                <input type="text" placeholder="è¾“å…¥é€‰é¡¹">
                <button onclick="removeOptionInDialog(this)">åˆ é™¤</button>
            `;
            optionsList.appendChild(optionItem);
            optionItem.querySelector('input').focus();
        }

        // åˆ é™¤é€‰é¡¹å‡½æ•°
        function removeOptionInDialog(button) {
            button.closest('.column-option-item').remove();
        }

        // å…³é—­å¼¹çª—å‡½æ•°
        function closeOptionsDialog() {
            document.querySelector('.options-dialog-overlay')?.remove();
            document.querySelector('.options-dialog')?.remove();
        }

        // æ·»åŠ ä¿å­˜é€‰é¡¹å‡½æ•°
        function saveOptions(columnIndex) {
            const dialog = document.querySelector('.options-dialog');
            const options = Array.from(dialog.querySelectorAll('.column-option-item input'))
                .map(input => input.value.trim())
                .filter(value => value !== '');
            
            localStorage.setItem(`column_${columnIndex}_options`, JSON.stringify(options));
            closeOptionsDialog();
        }

        // æ·»åŠ å•å…ƒæ ¼ç¼–è¾‘åŠŸèƒ½
        function initializeCellEditing() {
            const tbody = document.querySelector('.scene-table tbody');
            
            // ç‚¹å‡»æˆ–è¾“å…¥äº‹ä»¶å¤„ç†
            tbody.addEventListener('click', handleCellEdit);
            tbody.addEventListener('input', handleCellEdit);
        }

        function handleCellEdit(e) {
            const cell = e.target.closest('td');
            if (!cell || cell.parentElement.firstElementChild === cell) return;

            const columnIndex = Array.from(cell.parentElement.children).indexOf(cell);
            const options = JSON.parse(localStorage.getItem(`column_${columnIndex}_options`) || '[]');
            
            if (options.length > 0) {
                const inputText = cell.textContent.toLowerCase();
                const matchingOptions = options.filter(opt => 
                    opt.toLowerCase().includes(inputText)
                );
                
                if (e.type === 'click' || matchingOptions.length > 0) {
                    showCellOptionsDropdown(cell, e.type === 'click' ? options : matchingOptions);
                } else {
                    document.querySelector('.cell-options-dropdown')?.remove();
                }
            }
        }

        // ä¿®æ”¹æ˜¾ç¤ºé€‰é¡¹ä¸‹æ‹‰èœå•å‡½æ•°
        function showCellOptionsDropdown(cell, options) {
            // ç§»é™¤ç°æœ‰çš„ä¸‹æ‹‰èœå•
            document.querySelectorAll('.cell-options-dropdown').forEach(el => el.remove());
            
            const dropdown = document.createElement('div');
            dropdown.className = 'cell-options-dropdown';
            dropdown.innerHTML = options.map(option => `
                <div class="cell-option-item">${option}</div>
            `).join('');
            
            // å®šä½ä¸‹æ‹‰èœå•
            const rect = cell.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = `${rect.bottom}px`;
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.minWidth = `${rect.width}px`;
            
            document.body.appendChild(dropdown);

            // ä¸ºé€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            dropdown.querySelectorAll('.cell-option-item').forEach(item => {
                item.addEventListener('click', () => {
                    cell.textContent = item.textContent;
                    cell.dispatchEvent(new Event('change', { bubbles: true }));
                    dropdown.remove();
                });
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.cell-options-dropdown') && !e.target.closest('td')) {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // ä¿®æ”¹åˆ—æ‹–åŠ¨ç›¸å…³å‡½æ•°
        function handleColumnDrop(e) {
            e.preventDefault();
            const draggingHeader = document.querySelector('th.dragging');
            const targetHeader = e.target.closest('th');
            
            if (!draggingHeader || !targetHeader) return;
            
            const table = document.querySelector('.scene-table');
            const draggingIndex = Array.from(draggingHeader.parentElement.children).indexOf(draggingHeader);
            const targetIndex = Array.from(targetHeader.parentElement.children).indexOf(targetHeader);
            
            if (draggingIndex !== targetIndex) {
                // ç§»åŠ¨æ‰€æœ‰è¡Œçš„å¯¹åº”åˆ—
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = Array.from(row.children);
                    const draggingCell = cells[draggingIndex];
                    const targetCell = cells[targetIndex];
                    
                    if (draggingIndex < targetIndex) {
                        targetCell.after(draggingCell);
                    } else {
                        targetCell.before(draggingCell);
                    }
                });

                // æ›´æ–°é€‰é¡¹çš„å­˜å‚¨ä½ç½®
                const draggingOptions = JSON.parse(localStorage.getItem(`column_${draggingIndex}_options`) || '[]');
                const targetOptions = JSON.parse(localStorage.getItem(`column_${targetIndex}_options`) || '[]');
                
                localStorage.setItem(`column_${draggingIndex}_options`, JSON.stringify(targetOptions));
                localStorage.setItem(`column_${targetIndex}_options`, JSON.stringify(draggingOptions));
            }
            
            targetHeader.classList.remove('drag-over');
        }

        // æ·»åŠ å†å²æ¨¡æ¿ç›¸å…³å‡½æ•°
        function toggleTemplateList(button) {
            const dropdown = button.parentElement;
            dropdown.classList.toggle('active');
        }

        // ä¿å­˜æ¨¡æ¿
        function saveTable() {
            const table = document.querySelector('.scene-table');
            const data = [];
            
            // è·å–è¡¨å¤´
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent.trim());
            });
            
            // è·å–è¡¨æ ¼æ•°æ®
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = {};
                tr.querySelectorAll('td').forEach((td, index) => {
                    row[headers[index]] = td.textContent.trim();
                });
                data.push(row);
            });
            
            // åˆ›å»ºæ¨¡æ¿å¯¹è±¡
            const template = {
                name: `æ¨¡æ¿ ${new Date().toLocaleString()}`,
                date: new Date().toISOString(),
                data: data
            };

            // è·å–ç°æœ‰æ¨¡æ¿
            let templates = JSON.parse(localStorage.getItem('sceneTemplates') || '[]');
            
            // æ·»åŠ æ–°æ¨¡æ¿
            templates.unshift(template);
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('sceneTemplates', JSON.stringify(templates));
            
            // æ›´æ–°æ¨¡æ¿åˆ—è¡¨æ˜¾ç¤º
            updateTemplateList();
            
            alert('ä¿å­˜æˆåŠŸï¼');
        }

        // æ›´æ–°æ¨¡æ¿åˆ—è¡¨
        function updateTemplateList() {
            const templateList = document.getElementById('templateList');
            const templates = JSON.parse(localStorage.getItem('sceneTemplates') || '[]');
            
            templateList.innerHTML = templates.map((template, index) => `
                <div class="template-list-item">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <div class="template-date">${new Date(template.date).toLocaleString()}</div>
                    </div>
                    <div class="template-actions">
                        <button onclick="loadTemplate(${index})">ä½¿ç”¨</button>
                        <button onclick="deleteTemplate(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // åŠ è½½æ¨¡æ¿
        function loadTemplate(index) {
            const templates = JSON.parse(localStorage.getItem('sceneTemplates') || '[]');
            const template = templates[index];
            
            if (!template) return;
            
            const tbody = document.querySelector('.scene-table tbody');
            tbody.innerHTML = '';
            
            template.data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                tr.draggable = true;
                addDragEvents(tr);
                
                Object.values(row).forEach((value, colIndex) => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    td.contentEditable = colIndex !== 0;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            // å…³é—­æ¨¡æ¿åˆ—è¡¨
            document.querySelector('.dropdown.active')?.classList.remove('active');
        }

        // åˆ é™¤æ¨¡æ¿
        function deleteTemplate(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
            
            let templates = JSON.parse(localStorage.getItem('sceneTemplates') || '[]');
            templates.splice(index, 1);
            localStorage.setItem('sceneTemplates', JSON.stringify(templates));
            
            updateTemplateList();
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeInsertButtons();
            initializeDragAndDrop();
            initializeColumnButtons();
            updateTemplateList();
            showTab(0);
            initializeCellEditing();
        });

        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        document.querySelector('.scene-table').addEventListener('input', function(e) {
            if(e.target.matches('td[contenteditable="true"]')) {
                // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨ä¿å­˜é€»è¾‘
                console.log('å†…å®¹å·²æ›´æ–°:', e.target.textContent);
            }
        });

        // æ·»åŠ é€‰æ‹©è¡Œçš„åŠŸèƒ½
        function toggleRowSelection(button) {
            button.classList.toggle('selected');
            const row = button.parentElement;
            row.classList.toggle('selected-row');
            updateSelectionStatus();
        }

        // ä¿®æ”¹æ›´æ–°é€‰æ‹©çŠ¶æ€å‡½æ•°
        function updateSelectionStatus() {
            const selectedRows = document.querySelectorAll('.scene-table tbody tr.selected-row');
            const bottomActions = document.querySelector('.bottom-actions');
            const selectionInfo = bottomActions.querySelector('.selection-info');
            
            if (selectedRows.length > 0) {
                bottomActions.classList.add('show');
                selectionInfo.textContent = `å·²é€‰ä¸­ ${selectedRows.length} ä¸ªé¡¹ç›®`;
            } else {
                bottomActions.classList.remove('show');
            }
        }

        // æ’å…¥é•œå¤´
        function insertShot() {
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            if (selectedRow) {
                const index = Array.from(selectedRow.parentElement.children).indexOf(selectedRow);
                addNewRow(index);
            }
        }

        // ç§»åŠ¨é•œå¤´
        function moveShot() {
            // è¿™é‡Œæ·»åŠ ç§»åŠ¨é•œå¤´çš„é€»è¾‘
            alert('ç§»åŠ¨é•œå¤´åŠŸèƒ½å¾…å®ç°');
        }

        // å¤åˆ¶é•œå¤´
        function copyShot() {
            const selectedRows = document.querySelectorAll('.scene-table tbody tr.selected-row');
            selectedRows.forEach(row => {
                const newRow = row.cloneNode(true);
                row.parentElement.insertBefore(newRow, row.nextSibling);
                addDragEvents(newRow);
                initializeRowButtons(newRow);
            });
            updateRowNumbers();
        }

        // åˆ é™¤é•œå¤´
        function deleteShot() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„é•œå¤´å—ï¼Ÿ')) return;
            
            const selectedRows = document.querySelectorAll('.scene-table tbody tr.selected-row');
            selectedRows.forEach(row => row.remove());
            updateRowNumbers();
            cancelSelection();
        }

        // å–æ¶ˆé€‰æ‹©
        function cancelSelection() {
            document.querySelectorAll('.scene-table tbody tr.selected-row').forEach(row => {
                row.classList.remove('selected-row');
                row.querySelector('.select-row-btn').classList.remove('selected');
            });
            updateSelectionStatus();
        }

        // åˆå§‹åŒ–è¡ŒæŒ‰é’®
        function initializeRowButtons(row) {
            // æ·»åŠ é€‰æ‹©æŒ‰é’®
            const selectBtn = document.createElement('button');
            selectBtn.className = 'select-row-btn';
            selectBtn.innerHTML = 'âœ“';
            selectBtn.onclick = (e) => {
                e.stopPropagation();
                toggleRowSelection(selectBtn);
            };
            row.appendChild(selectBtn);
        }

        // å‘å‰æ’å…¥é•œå¤´
        function insertShotBefore() {
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            if (selectedRow) {
                const index = Array.from(selectedRow.parentElement.children).indexOf(selectedRow);
                addNewRow(index - 1);
            }
        }

        // å‘åæ’å…¥é•œå¤´
        function insertShotAfter() {
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            if (selectedRow) {
                const index = Array.from(selectedRow.parentElement.children).indexOf(selectedRow);
                addNewRow(index);
            }
        }

        // ç§»åŠ¨åˆ°æœ€å‰é¢
        function moveShotToFront() {
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            if (selectedRow) {
                const tbody = selectedRow.parentElement;
                tbody.insertBefore(selectedRow, tbody.firstChild);
                updateRowNumbers();
            }
        }

        // æ˜¾ç¤ºç§»åŠ¨ä½ç½®å¯¹è¯æ¡†
        function moveShotToPosition() {
            document.querySelector('.move-dialog-overlay').style.display = 'block';
            document.querySelector('.move-dialog').style.display = 'block';
            document.getElementById('targetPosition').value = '';
            document.getElementById('targetPosition').focus();
        }

        // å…³é—­å¯¹è¯æ¡†
        function closeDialog() {
            document.querySelector('.move-dialog-overlay').style.display = 'none';
            document.querySelector('.move-dialog').style.display = 'none';
        }

        // ç¡®è®¤ç§»åŠ¨
        function confirmMove() {
            const targetPosition = parseInt(document.getElementById('targetPosition').value);
            const tbody = document.querySelector('.scene-table tbody');
            const rows = tbody.children;
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            
            if (targetPosition && selectedRow && targetPosition > 0 && targetPosition <= rows.length) {
                const targetRow = rows[targetPosition - 1];
                tbody.insertBefore(selectedRow, targetRow.nextSibling);
                updateRowNumbers();
                closeDialog();
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é•œå·ï¼');
            }
        }

        // ç§»åŠ¨åˆ°æœ€åé¢
        function moveShotToEnd() {
            const selectedRow = document.querySelector('.scene-table tbody tr.selected-row');
            if (selectedRow) {
                const tbody = selectedRow.parentElement;
                tbody.appendChild(selectedRow);
                updateRowNumbers();
            }
        }

        // æ·»åŠ å­èœå•åˆ‡æ¢åŠŸèƒ½
        document.querySelectorAll('.has-submenu > button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                // å…³é—­å…¶ä»–æ‰“å¼€çš„å­èœå•
                document.querySelectorAll('.has-submenu.active').forEach(menu => {
                    if (menu !== button.parentElement) {
                        menu.classList.remove('active');
                    }
                });
                // åˆ‡æ¢å½“å‰å­èœå•
                button.parentElement.classList.toggle('active');
            });
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶å…³é—­å­èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.has-submenu')) {
                document.querySelectorAll('.has-submenu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // ä¿®æ”¹åˆå§‹åŒ–åˆ—æ‹–åŠ¨å‡½æ•°
        function initializeColumnDrag() {
            const headers = document.querySelectorAll('.scene-table th');
            headers.forEach(header => {
                header.setAttribute('draggable', 'true');
                header.addEventListener('dragstart', handleColumnDragStart);
                header.addEventListener('dragend', handleColumnDragEnd);
                header.addEventListener('dragover', handleColumnDragOver);
                header.addEventListener('drop', handleColumnDrop);
            });
        }

        // åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨åˆ—æ‹–åŠ¨åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...
            initializeColumnDrag();
        });

        // ä¿®æ”¹åˆ—æ‹–åŠ¨ç›¸å…³å‡½æ•°
        function handleColumnDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.cellIndex);
        }

        function handleColumnDragEnd(e) {
            this.classList.remove('dragging');
        }

        function handleColumnDragOver(e) {
            e.preventDefault();
            const draggingHeader = document.querySelector('th.dragging');
            if (!draggingHeader) return;

            const currentHeader = e.target.closest('th');
            if (currentHeader && currentHeader !== draggingHeader) {
                const headers = Array.from(currentHeader.parentElement.children);
                const draggingIndex = headers.indexOf(draggingHeader);
                const targetIndex = headers.indexOf(currentHeader);

                if (draggingIndex !== targetIndex) {
                    headers.forEach(h => h.classList.remove('drag-over'));
                    currentHeader.classList.add('drag-over');
                }
            }
        }

        function handleColumnDrop(e) {
            e.preventDefault();
            const draggingHeader = document.querySelector('th.dragging');
            const targetHeader = e.target.closest('th');
            
            if (!draggingHeader || !targetHeader) return;
            
            const table = document.querySelector('.scene-table');
            const draggingIndex = Array.from(draggingHeader.parentElement.children).indexOf(draggingHeader);
            const targetIndex = Array.from(targetHeader.parentElement.children).indexOf(targetHeader);
            
            if (draggingIndex !== targetIndex) {
                // ç§»åŠ¨æ‰€æœ‰è¡Œçš„å¯¹åº”åˆ—
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = Array.from(row.children);
                    const draggingCell = cells[draggingIndex];
                    const targetCell = cells[targetIndex];
                    
                    if (draggingIndex < targetIndex) {
                        targetCell.after(draggingCell);
                    } else {
                        targetCell.before(draggingCell);
                    }
                });

                // æ›´æ–°é€‰é¡¹çš„å­˜å‚¨ä½ç½®
                const draggingOptions = JSON.parse(localStorage.getItem(`column_${draggingIndex}_options`) || '[]');
                const targetOptions = JSON.parse(localStorage.getItem(`column_${targetIndex}_options`) || '[]');
                
                localStorage.setItem(`column_${draggingIndex}_options`, JSON.stringify(targetOptions));
                localStorage.setItem(`column_${targetIndex}_options`, JSON.stringify(draggingOptions));
            }
            
            targetHeader.classList.remove('drag-over');
        }

        // ä¿®æ”¹é€‰æ‹©ç©ºé•œå¤´åŠŸèƒ½
        function selectEmptyRows() {
            const tbody = document.querySelector('.scene-table tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // è·å–æ‰€æœ‰å•å…ƒæ ¼ï¼Œè·³è¿‡ç¬¬ä¸€åˆ—ï¼ˆæ’åºï¼‰å’Œç¬¬äºŒåˆ—ï¼ˆé•œå·ï¼‰
                const cells = Array.from(row.cells).slice(2);
                
                // æ£€æŸ¥é™¤æ’åºå’Œé•œå·å¤–çš„æ‰€æœ‰å•å…ƒæ ¼æ˜¯å¦ä¸ºç©º
                const isEmpty = cells.every(cell => {
                    const content = cell.textContent.trim();
                    return content === '' || content === 'ç‚¹å‡»ç¼–è¾‘';
                });
                
                if (isEmpty) {
                    // é€‰ä¸­ç©ºè¡Œ
                    row.classList.add('selected-row');
                    const selectBtn = row.querySelector('.select-row-btn');
                    if (selectBtn) {
                        selectBtn.classList.add('selected');
                    }
                }
            });
            
            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            updateSelectionStatus();
            
            // å…³é—­å­èœå•
            document.querySelectorAll('.submenu.active').forEach(menu => {
                menu.classList.remove('active');
            });
        }

        // ä¿®æ”¹åˆå§‹åŒ–å­èœå•å‡½æ•°
        function initializeSubmenus() {
            const selectMenu = document.querySelector('.select-menu');
            selectMenu.innerHTML = `
                <button onclick="toggleSubmenu(this)">
                    é€‰æ‹© â–¼
                </button>
                <div class="submenu">
                    <button onclick="selectEmptyRows()">é€‰ä¸­ç©ºé•œå¤´</button>
                    <button onclick="selectAllRows()">å…¨é€‰</button>
                    <button onclick="cancelSelection()">å–æ¶ˆé€‰æ‹©</button>
                </div>
            `;
        }

        // ä¿®æ”¹å­èœå•åˆ‡æ¢å‡½æ•°
        function toggleSubmenu(button) {
            const submenu = button.closest('.select-menu').querySelector('.submenu');
            const isActive = submenu.classList.contains('active');
            
            // å…³é—­æ‰€æœ‰æ‰“å¼€çš„å­èœå•
            document.querySelectorAll('.submenu.active').forEach(menu => {
                menu.classList.remove('active');
            });
            
            // å¦‚æœå½“å‰å­èœå•æœªæ‰“å¼€ï¼Œåˆ™æ‰“å¼€å®ƒ
            if (!isActive) {
                submenu.classList.add('active');
            }
        }

        // æ·»åŠ å…¨é€‰åŠŸèƒ½
        function selectAllRows() {
            const tbody = document.querySelector('.scene-table tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                row.classList.add('selected-row');
                const selectBtn = row.querySelector('.select-row-btn');
                if (selectBtn) {
                    selectBtn.classList.add('selected');
                }
            });
            
            updateSelectionStatus();
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å­èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.select-menu')) {
                document.querySelectorAll('.submenu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        });

        // ä¿®æ”¹è¡¨æ ¼ç»“æ„ï¼Œåœ¨å†…å®¹å’Œå¤‡æ³¨ä¹‹é—´æ·»åŠ å°è¯åˆ—
        function initializeTable() {
            const table = document.querySelector('.scene-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // ä¿®æ”¹è¡¨å¤´è¡Œ
            const headerRow = thead.querySelector('tr');
            const contentHeader = headerRow.querySelector('th:nth-child(4)'); // å‡è®¾"å†…å®¹"æ˜¯ç¬¬4åˆ—
            
            // åˆ›å»ºå°è¯åˆ—è¡¨å¤´
            const scriptHeader = document.createElement('th');
            scriptHeader.textContent = 'å°è¯';
            scriptHeader.contentEditable = true;
            scriptHeader.setAttribute('draggable', 'true');
            
            // åœ¨å†…å®¹åˆ—åæ’å…¥å°è¯åˆ—
            contentHeader.after(scriptHeader);
            
            // ä¸ºæ‰€æœ‰ç°æœ‰è¡Œæ·»åŠ å°è¯å•å…ƒæ ¼
            tbody.querySelectorAll('tr').forEach(row => {
                const contentCell = row.querySelector('td:nth-child(4)');
                const scriptCell = document.createElement('td');
                scriptCell.contentEditable = true;
                contentCell.after(scriptCell);
            });
            
            // åˆå§‹åŒ–åˆ—æŒ‰é’®
            initializeColumnButtons();
        }

        // æ·»åŠ åˆ†é•œè®¾ç½®ç›¸å…³å‡½æ•°
        function toggleSceneSettings(button) {
            const menu = button.nextElementSibling;
            const isActive = menu.classList.contains('active');
            
            // å…³é—­æ‰€æœ‰æ‰“å¼€çš„èœå•
            document.querySelectorAll('.scene-settings-menu.active, .submenu.active').forEach(m => {
                m.classList.remove('active');
            });
            
            // å¦‚æœå½“å‰èœå•æœªæ‰“å¼€ï¼Œåˆ™æ‰“å¼€å®ƒ
            if (!isActive) {
                menu.classList.add('active');
            }
        }

        function openTextSizeSettings() {
            alert('æ–‡å­—å¤§å°è®¾ç½®åŠŸèƒ½å¾…å®ç°');
            closeAllMenus();
        }

        function openImageRatioSettings() {
            alert('å›¾ç‰‡æ¯”ä¾‹è®¾ç½®åŠŸèƒ½å¾…å®ç°');
            closeAllMenus();
        }

        function openImageFitSettings() {
            alert('å›¾ç‰‡é€‚é…è®¾ç½®åŠŸèƒ½å¾…å®ç°');
            closeAllMenus();
        }

        function openSceneNumberSettings() {
            alert('é•œå·è®¾ç½®åŠŸèƒ½å¾…å®ç°');
            closeAllMenus();
        }

        function closeAllMenus() {
            document.querySelectorAll('.scene-settings-menu.active, .submenu.active').forEach(menu => {
                menu.classList.remove('active');
            });
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.select-menu')) {
                closeAllMenus();
            }
        });

        // ä¿®æ”¹æ–‡å­—å¤§å°ç›¸å…³å‡½æ•°
        function toggleFontSizeMenu(button) {
            const submenu = button.nextElementSibling;
            const isActive = submenu.style.display === 'block';
            
            // å…³é—­æ‰€æœ‰å…¶ä»–å­èœå•
            document.querySelectorAll('.font-size-submenu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // å¦‚æœå½“å‰å­èœå•æœªæ‰“å¼€ï¼Œåˆ™æ‰“å¼€å®ƒ
            if (!isActive) {
                submenu.style.display = 'block';
            }
        }

        // ä¿®æ”¹å­—ä½“å¤§å°
        function changeFontSize(size) {
            const table = document.querySelector('.scene-table');
            const currentSize = getCurrentFontSizeLevel(table);
            
            // æ ¹æ®å½“å‰ç‚¹å‡»çš„æŒ‰é’®å’Œå½“å‰å­—ä½“å¤§å°å†³å®šä¸‹ä¸€ä¸ªå­—ä½“å¤§å°
            let nextSize;
            if (size === 'large') {
                switch (currentSize) {
                    case 'normal': nextSize = 'large'; break;
                    case 'large': nextSize = 'xl'; break;
                    case 'xl': nextSize = 'xl-plus'; break;
                    case 'xl-plus': nextSize = 'xxl'; break;
                    case 'xxl': nextSize = 'xxl'; break;  // å·²ç»æ˜¯æœ€å¤§
                    case 'small': nextSize = 'normal'; break;
                    case 'xs': nextSize = 'small'; break;
                    default: nextSize = 'large';
                }
            } else if (size === 'small') {
                switch (currentSize) {
                    case 'normal': nextSize = 'small'; break;
                    case 'small': nextSize = 'xs'; break;
                    case 'xs': nextSize = 'xs'; break;  // å·²ç»æ˜¯æœ€å°
                    case 'large': nextSize = 'normal'; break;
                    case 'xl': nextSize = 'large'; break;
                    case 'xl-plus': nextSize = 'xl'; break;
                    case 'xxl': nextSize = 'xl-plus'; break;
                    default: nextSize = 'small';
                }
            }
            
            // ç§»é™¤æ‰€æœ‰å­—ä½“å¤§å°ç±»
            table.classList.remove(
                'font-size-xxl',
                'font-size-xl-plus',
                'font-size-xl',
                'font-size-large',
                'font-size-normal',
                'font-size-small',
                'font-size-xs'
            );
            
            // æ·»åŠ æ–°çš„å­—ä½“å¤§å°ç±»
            if (nextSize) {
                table.classList.add(`font-size-${nextSize}`);
                // ä¿å­˜å­—ä½“å¤§å°è®¾ç½®åˆ°localStorage
                localStorage.setItem('tableFontSize', nextSize);
            }
        }

        // è·å–å½“å‰å­—ä½“å¤§å°çº§åˆ«
        function getCurrentFontSizeLevel(table) {
            if (table.classList.contains('font-size-xxl')) return 'xxl';
            if (table.classList.contains('font-size-xl-plus')) return 'xl-plus';
            if (table.classList.contains('font-size-xl')) return 'xl';
            if (table.classList.contains('font-size-large')) return 'large';
            if (table.classList.contains('font-size-small')) return 'small';
            if (table.classList.contains('font-size-xs')) return 'xs';
            return 'normal';  // é»˜è®¤å¤§å°
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶æ¢å¤å­—ä½“å¤§å°è®¾ç½®
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.querySelector('.scene-table');
            const savedSize = localStorage.getItem('tableFontSize');
            
            // è®¾ç½®é»˜è®¤å­—ä½“å¤§å°ç±»
            if (!savedSize) {
                table.classList.add('font-size-normal');
            } else {
                table.classList.add(`font-size-${savedSize}`);
            }
        });

        // é•œå·è®¾ç½®ç›¸å…³å‡½æ•°
        function toggleSceneNumberMenu(button) {
            const submenu = button.nextElementSibling;
            const isActive = submenu.style.display === 'block';
            
            // å…³é—­æ‰€æœ‰å…¶ä»–å­èœå•
            document.querySelectorAll('.scene-number-submenu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // å¦‚æœå½“å‰å­èœå•æœªæ‰“å¼€ï¼Œåˆ™æ‰“å¼€å®ƒ
            if (!isActive) {
                submenu.style.display = 'block';
            }
        }

        // ä¿®æ”¹é•œå·è®¾ç½®ç›¸å…³å‡½æ•°
        function toggleCustomSceneNumber(checkbox) {
            const table = document.querySelector('.scene-table');
            const sceneNumberCells = table.querySelectorAll('td:nth-child(2)');
            
            if (checkbox.checked) {
                // å¯ç”¨è‡ªå®šä¹‰é•œå·
                sceneNumberCells.forEach(cell => {
                    cell.contentEditable = true;
                    cell.style.backgroundColor = '#f8f9fa';  // è½»å¾®èƒŒæ™¯è‰²è¡¨ç¤ºå¯ç¼–è¾‘
                });
                // ä¿å­˜è®¾ç½®
                localStorage.setItem('customSceneNumber', 'true');
            } else {
                // ç¦ç”¨è‡ªå®šä¹‰é•œå·ï¼Œæ¢å¤è‡ªåŠ¨ç¼–å·
                sceneNumberCells.forEach(cell => {
                    cell.contentEditable = false;
                    cell.style.backgroundColor = '';
                });
                // æ›´æ–°é•œå·
                updateRowNumbers();
                // ä¿å­˜è®¾ç½®
                localStorage.setItem('customSceneNumber', 'false');
            }
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–é•œå·è®¾ç½®ä¸ºå…³é—­çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.querySelector('.scene-number-submenu input[type="checkbox"]');
            if (checkbox) {
                // é»˜è®¤è®¾ç½®ä¸ºæœªé€‰ä¸­çŠ¶æ€
                checkbox.checked = false;
                
                // ç¦ç”¨è‡ªå®šä¹‰é•œå·
                const sceneNumberCells = document.querySelectorAll('.scene-table td:nth-child(2)');
                sceneNumberCells.forEach(cell => {
                    cell.contentEditable = false;
                    cell.style.backgroundColor = '';
                });
                
                // æ›´æ–°é•œå·
                updateRowNumbers();
                
                // ä¿å­˜é»˜è®¤è®¾ç½®
                localStorage.setItem('customSceneNumber', 'false');
            }
        });

        // ä¿®æ”¹å¯¼å‡ºä¸ºExcelçš„å‡½æ•°
        function exportToExcel() {
            const table = document.querySelector('.scene-table');
            const data = [];
            
            // è·å–è¡¨å¤´ï¼ˆæ’é™¤æ’å…¥æŒ‰é’®ï¼‰
            const headers = [];
            table.querySelectorAll('thead th').forEach(th => {
                // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼Œå»é™¤æŒ‰é’®ç­‰å…ƒç´ 
                const text = th.cloneNode(true);
                text.querySelectorAll('button').forEach(btn => btn.remove());
                headers.push(text.textContent.trim());
            });
            
            // CSVçš„è¡¨å¤´è¡Œ
            let csvContent = "\uFEFF"; // æ·»åŠ BOMï¼Œè§£å†³ä¸­æ–‡ä¹±ç 
            csvContent += headers.map(header => `"${header}"`).join(",") + "\n";
            
            // è·å–æ•°æ®è¡Œ
            table.querySelectorAll('tbody tr').forEach(tr => {
                const rowData = [];
                tr.querySelectorAll('td').forEach(td => {
                    // å¤„ç†å•å…ƒæ ¼å†…å®¹ï¼Œç¡®ä¿ç‰¹æ®Šå­—ç¬¦ä¸ä¼šç ´åCSVæ ¼å¼
                    const cellContent = td.textContent.trim();
                    // å°†å†…å®¹åŒ…è£¹åœ¨å¼•å·ä¸­ï¼Œå¤„ç†å†…å®¹ä¸­çš„å¼•å·
                    const escapedContent = cellContent.replace(/"/g, '""');
                    rowData.push(`"${escapedContent}"`);
                });
                csvContent += rowData.join(",") + "\n";
            });
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "åˆ†é•œè¡¨.csv");
            document.body.appendChild(link);
            
            // è§¦å‘ä¸‹è½½
            link.click();
            
            // æ¸…ç†
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ä¿®æ”¹å¯¼å‡ºPDFå‡½æ•°
        function exportToPDF() {
            const table = document.querySelector('.scene-table');
            const clone = table.cloneNode(true);
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®å’Œæ“ä½œå…ƒç´ 
            clone.querySelectorAll('button, .insert-row-btn, .select-row-btn').forEach(el => el.remove());
            
            // ç§»é™¤æ’åºåˆ—ï¼ˆç¬¬ä¸€åˆ—ï¼‰
            const allRows = clone.querySelectorAll('tr');
            allRows.forEach(row => {
                if (row.cells.length > 0) {
                    row.deleteCell(0); // åˆ é™¤ç¬¬ä¸€åˆ—
                }
            });
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨
            const container = document.createElement('div');
            container.style.padding = '20px';
            
            // æ·»åŠ æ ‡é¢˜ï¼ˆåªåœ¨ç¬¬ä¸€é¡µæ˜¾ç¤ºï¼‰
            const titleContainer = document.createElement('div');
            titleContainer.style.textAlign = 'center';
            titleContainer.style.marginBottom = '20px';
            titleContainer.style.fontSize = '16pt';
            titleContainer.style.fontWeight = 'bold';
            titleContainer.style.color = '#333333';
            titleContainer.textContent = 'åˆ†é•œè¡¨';
            container.appendChild(titleContainer);
            
            // è·å–æ‰€æœ‰è¡Œ
            const rows = Array.from(clone.querySelectorAll('tr'));
            const headerRow = rows[0];
            const dataRows = rows.slice(1);
            
            // åˆ›å»ºä¸´æ—¶è¡¨æ ¼æ¥è®¡ç®—å®é™…è¡Œé«˜
            const tempTable = document.createElement('table');
            tempTable.style.visibility = 'hidden';
            tempTable.style.position = 'absolute';
            tempTable.style.width = '100%';
            document.body.appendChild(tempTable);
            
            // ä¿®æ”¹åˆ†é¡µç›¸å…³çš„å¸¸é‡
            const pages = [];
            let currentPage = [];
            let currentHeight = 0;
            const maxPageHeight = 297; // A4çº¸é«˜åº¦297mm
            const headerHeight = 20; // é€‚å½“å‡å°è¡¨å¤´é«˜åº¦
            const safetyMargin = 5; // å‡å°å®‰å…¨è¾¹è·
            const minRowSpacing = 2; // å‡å°è¡Œé—´æœ€å°é—´è·
            
            dataRows.forEach((row, index) => {
                // åˆ›å»ºä¸´æ—¶è¡Œæ¥è®¡ç®—å®é™…é«˜åº¦
                const tempRow = row.cloneNode(true);
                tempTable.appendChild(tempRow);
                
                // è·å–è¡Œçš„å®é™…å†…å®¹é«˜åº¦
                const cells = Array.from(tempRow.cells);
                let maxCellHeight = 0;
                
                cells.forEach(cell => {
                    // å…‹éš†å•å…ƒæ ¼å†…å®¹åˆ°ä¸´æ—¶divä»¥è®¡ç®—å®é™…é«˜åº¦
                    const tempDiv = document.createElement('div');
                    tempDiv.style.visibility = 'hidden';
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.width = cell.offsetWidth + 'px';
                    tempDiv.style.padding = '8px';
                    tempDiv.style.fontSize = '10pt';
                    tempDiv.style.lineHeight = '1.4';
                    tempDiv.style.whiteSpace = 'pre-wrap';
                    tempDiv.style.wordBreak = 'break-word';
                    tempDiv.innerHTML = cell.innerHTML;
                    document.body.appendChild(tempDiv);
                    
                    const cellHeight = tempDiv.offsetHeight * 0.264583; // è½¬æ¢ä¸ºmm
                    maxCellHeight = Math.max(maxCellHeight, cellHeight);
                    
                    document.body.removeChild(tempDiv);
                });
                
                tempTable.removeChild(tempRow);
                
                // è®¡ç®—è¡Œçš„æ€»é«˜åº¦ï¼ŒåŒ…æ‹¬å†…å®¹ã€paddingå’Œè¾¹æ¡†
                const rowHeight = maxCellHeight + 8; // å¢åŠ paddingç©ºé—´
                
                // æ£€æŸ¥å½“å‰é¡µå‰©ä½™ç©ºé—´
                const availableHeight = maxPageHeight - headerHeight - safetyMargin;
                const remainingHeight = availableHeight - currentHeight;
                
                // åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†é¡µ
                const needNewPage = currentHeight > 0 && (
                    // å‰©ä½™ç©ºé—´ä¸è¶³ä»¥å®¹çº³å½“å‰è¡ŒåŠ ä¸Šæœ€å°é—´è·
                    remainingHeight < rowHeight + minRowSpacing ||
                    // æˆ–è€…æ˜¯æœ€åä¸€è¡Œï¼Œä½†åªæœ‰åœ¨å½“å‰é¡µå†…å®¹è¶…è¿‡ä¸€å®šæ¯”ä¾‹æ—¶æ‰åˆ†é¡µ
                    (index === dataRows.length - 1 && currentHeight > availableHeight * 0.75)
                );

                if (needNewPage) {
                    if (currentPage.length > 0) {
                        pages.push(currentPage);
                        currentPage = [];
                        currentHeight = 0;
                    }
                }
                
                // å¦‚æœå½“å‰è¡Œé«˜åº¦è¶…è¿‡å¯ç”¨ç©ºé—´ï¼Œä¸”ä¸æ˜¯æœ€åå‡ è¡Œï¼Œå•ç‹¬æ”¾ä¸€é¡µ
                if (rowHeight > availableHeight && index < dataRows.length - 3) {
                    if (currentPage.length > 0) {
                        pages.push(currentPage);
                        currentPage = [];
                        currentHeight = 0;
                    }
                    pages.push([row]);
                    return;
                }
                
                // æ·»åŠ å½“å‰è¡Œåˆ°å½“å‰é¡µ
                currentPage.push(row);
                currentHeight += rowHeight + minRowSpacing;
                
                // å¤„ç†æœ€åä¸€é¡µï¼Œç¡®ä¿ä¸ä¼šå‡ºç°ä¸å¿…è¦çš„åˆ†é¡µ
                if (index === dataRows.length - 1 && currentPage.length > 0) {
                    // åªæœ‰å½“æœ€åä¸€é¡µå†…å®¹è¶…è¿‡ä¸€å®šé«˜åº¦æ—¶æ‰ä½œä¸ºå•ç‹¬çš„é¡µ
                    if (currentHeight > availableHeight * 0.4) {
                        pages.push(currentPage);
                    } else {
                        // å¦åˆ™å°è¯•åˆå¹¶åˆ°å‰ä¸€é¡µ
                        const lastPage = pages[pages.length - 1] || [];
                        pages[pages.length - 1] = [...lastPage, ...currentPage];
                    }
                }
            });
            
            // æ¸…ç†ä¸´æ—¶è¡¨æ ¼
            document.body.removeChild(tempTable);

            // åœ¨ç”ŸæˆPDFä¹‹å‰è°ƒæ•´è¡¨æ ¼åˆ—å®½å’Œå­—ä½“å¤§å°
            function adjustTableForPDF(table) {
                const pageWidth = 210; // A4çº¸å®½åº¦ä¸º210mm
                const margins = 10; // æ€»è¾¹è·ä¸º10mmï¼ˆå·¦å³å„5mmï¼‰
                const availableWidth = pageWidth - margins;
                
                const columns = table.querySelectorAll('thead th');
                const columnCount = columns.length;
                const columnWidth = availableWidth / columnCount;
                
                columns.forEach(column => {
                    column.style.width = `${columnWidth}mm`;
                });
                
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        cell.style.width = `${columnWidth}mm`;
                        cell.style.fontSize = '9pt'; // è°ƒæ•´å­—ä½“å¤§å°
                        cell.style.lineHeight = '1.2'; // è°ƒæ•´è¡Œé«˜
                    });
                });
            }

            // åœ¨ç”ŸæˆPDFæ—¶è°ƒç”¨è°ƒæ•´è¡¨æ ¼çš„å‡½æ•°
            const tables = pages.map((pageRows, pageIndex) => {
                const newTable = document.createElement('table');
                newTable.style.width = '100%';
                newTable.style.borderCollapse = 'collapse';
                newTable.style.marginBottom = pageIndex < pages.length - 1 ? '20px' : '0';
                
                // è°ƒæ•´è¡¨æ ¼
                adjustTableForPDF(newTable);
                
                // åˆ›å»ºè¡¨æ ¼åŒ…è£…å™¨
                const tableWrapper = document.createElement('div');
                tableWrapper.style.pageBreakInside = 'avoid'; // é˜²æ­¢è¡¨æ ¼å†…éƒ¨æ–­é¡µ
                tableWrapper.style.pageBreakAfter = pageIndex < pages.length - 1 ? 'always' : 'auto';
                
                // æ·»åŠ è¡¨å¤´
                const thead = document.createElement('thead');
                thead.style.display = 'table-header-group'; // ç¡®ä¿è¡¨å¤´åœ¨æ¯é¡µé‡å¤
                const newHeaderRow = headerRow.cloneNode(true);
                Array.from(newHeaderRow.cells).forEach(cell => {
                    cell.style.backgroundColor = '#333333';
                    cell.style.color = '#ffffff';
                    cell.style.padding = '8px';
                    cell.style.border = '1px solid #000';
                    cell.style.fontWeight = 'bold';
                    cell.style.textAlign = 'center';
                    cell.style.fontSize = '9pt'; // è°ƒæ•´å­—ä½“å¤§å°
                });
                thead.appendChild(newHeaderRow);
                newTable.appendChild(thead);
                
                // æ·»åŠ æ•°æ®è¡Œ
                const tbody = document.createElement('tbody');
                tbody.style.pageBreakInside = 'avoid'; // é˜²æ­¢æ•°æ®è¡Œæ–­é¡µ
                pageRows.forEach(row => {
                    const newRow = row.cloneNode(true);
                    Array.from(newRow.cells).forEach(cell => {
                        cell.style.border = '1px solid #000';
                        cell.style.padding = '8px';
                        cell.style.textAlign = 'center';
                        cell.style.verticalAlign = 'middle';
                        cell.style.fontSize = '9pt'; // è°ƒæ•´å­—ä½“å¤§å°
                        cell.style.lineHeight = '1.2'; // è°ƒæ•´è¡Œé«˜
                        cell.style.height = 'auto';
                        cell.style.wordBreak = 'break-word';
                        cell.style.whiteSpace = 'pre-wrap';
                    });
                    tbody.appendChild(newRow);
                });
                newTable.appendChild(tbody);
                
                // å°†è¡¨æ ¼æ·»åŠ åˆ°åŒ…è£…å™¨ä¸­
                tableWrapper.appendChild(newTable);
                return tableWrapper;
            });
            
            // å°†æ‰€æœ‰è¡¨æ ¼æ·»åŠ åˆ°å®¹å™¨ä¸­
            tables.forEach((table, index) => {
                if (index === 0) {
                    // ç¬¬ä¸€ä¸ªè¡¨æ ¼æ·»åŠ é¢å¤–çš„ä¸Šè¾¹è·ï¼Œä¸ºæ ‡é¢˜ç•™å‡ºç©ºé—´
                    table.style.marginTop = '10mm';
                }
                container.appendChild(table);
            });
            
            // é…ç½®PDFé€‰é¡¹
            const opt = {
                margin: [5, 5, 5, 5], // å°†è¾¹è·æ”¹ä¸º5mmï¼ˆä¸Šå³ä¸‹å·¦ï¼‰
                filename: 'åˆ†é•œè¡¨.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    scrollY: 0
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.page-break-before',
                    after: '.page-break-after'
                }
            };
            
            // ç”ŸæˆPDF
            html2pdf().set(opt).from(container).save().catch(err => {
                console.error('PDFç”Ÿæˆå¤±è´¥:', err);
                alert('PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
    </script>
</body>
</html>

